name: Reusable Docker Build and Push

on:
  workflow_call:
    inputs:
      registry:
        description: 'Docker registry/organization'
        required: true
        type: string
      image_name:
        description: 'Docker image name'
        required: true
        type: string
      context:
        description: 'Build context path'
        required: false
        type: string
        default: '.'
    secrets:
      docker_username:
        description: 'Docker Hub username'
        required: true
      docker_password:
        description: 'Docker Hub password/token'
        required: true

jobs:
  validate-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper version calculation

      - name: Validate branch name
        id: validate
        uses: ./.github/actions/validate-branch

      - name: Calculate version
        id: version
        uses: ./.github/actions/calculate-version
        with:
          branch_type: ${{ steps.validate.outputs.branch_type }}
          ticket: ${{ steps.validate.outputs.ticket }}

      - name: Build and push Docker image
        id: docker_build
        uses: ./.github/actions/docker-build-push
        with:
          registry: ${{ inputs.registry }}
          image_name: ${{ inputs.image_name }}
          docker_tag: ${{ steps.version.outputs.docker_tag }}
          additional_tags: ${{ steps.version.outputs.additional_tags }}
          docker_username: ${{ secrets.docker_username }}
          docker_password: ${{ secrets.docker_password }}
          context: ${{ inputs.context }}

      - name: Create git tag for release branches
        if: steps.validate.outputs.branch_type == 'release'
        uses: ./.github/actions/create-git-tag
        with:
          git_tag: ${{ steps.version.outputs.git_tag }}

      - name: Output summary
        uses: ./.github/actions/output-summary
        with:
          branch_name: ${{ steps.validate.outputs.branch_name }}
          branch_type: ${{ steps.validate.outputs.branch_type }}
          version: ${{ steps.version.outputs.version }}
          docker_tag: ${{ steps.version.outputs.docker_tag }}
          registry: ${{ inputs.registry }}
          image_name: ${{ inputs.image_name }}
          additional_tags: ${{ steps.version.outputs.additional_tags }}
